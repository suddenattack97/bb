<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BTC/USDT 1ë¶„ë´‰ ì ì¤‘ë¥  ê²€ì¦ ì°¨íŠ¸</title>

  <!-- Lightweight Charts v4 (standalone) -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Malgun Gothic', 'Segoe UI', sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 14px 18px;
    }

    /* â”€â”€ í—¤ë” íŒ¨ë„ â”€â”€ */
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 12px 18px;
    }
    #header h1 { font-size: 1rem; font-weight: 600; color: #e6edf3; }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 0.82rem;
      color: #8b949e;
    }
    .meta-row span { white-space: nowrap; }
    .meta-row strong { color: #c9d1d9; }

    /* ì›¹ì†Œì¼“ ìƒíƒœ ë„íŠ¸ */
    #ws-dot {
      display: inline-block;
      width: 9px; height: 9px;
      border-radius: 50%;
      background: #6e7681;
      margin-right: 4px;
      vertical-align: middle;
      transition: background 0.3s;
    }
    #ws-dot.connected    { background: #3fb950; box-shadow: 0 0 6px #3fb95088; }
    #ws-dot.connecting   { background: #d29922; }
    #ws-dot.disconnected { background: #f85149; }

    /* â”€â”€ ë²„íŠ¼ ê·¸ë£¹ â”€â”€ */
    .btn-group { display: flex; gap: 8px; }
    button {
      padding: 7px 14px;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      font-family: inherit;
      transition: opacity 0.15s;
    }
    button:hover { opacity: 0.85; }
    #btn-snapshot { background: #2962ff; color: #fff; }
    #btn-reset    { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }

    /* â”€â”€ ì°¨íŠ¸ ì˜ì—­ â”€â”€ */
    #chart-wrapper {
      position: relative;
      background: #131722;
      border: 1px solid #30363d;
      border-radius: 8px;
      overflow: hidden;
      flex: 1;
      min-height: 460px;
    }
    #chart-container { width: 100%; height: 100%; min-height: 460px; }

    /* ì°¨íŠ¸ ìœ„ ì˜¤ë²„ë ˆì´ ë©”ì‹œì§€ (ì´ˆê¸° ì—°ê²° ëŒ€ê¸° ë“±) */
    #chart-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(19,23,34,0.7);
      font-size: 1rem;
      color: #8b949e;
      pointer-events: none;
      transition: opacity 0.4s;
    }
    #chart-overlay.hidden { opacity: 0; }

    /* â”€â”€ í†µê³„ ë°” â”€â”€ */
    #stats-bar {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 0.82rem;
    }
    .stat-item { display: flex; flex-direction: column; gap: 2px; }
    .stat-label { color: #8b949e; font-size: 0.73rem; text-transform: uppercase; letter-spacing: 0.04em; }
    .stat-value { color: #e6edf3; font-size: 0.95rem; font-weight: 600; font-variant-numeric: tabular-nums; }
    .stat-value.up   { color: #3fb950; }
    .stat-value.down { color: #f85149; }

    /* â”€â”€ ìŠ¤ëƒ…ìƒ· ê°¤ëŸ¬ë¦¬ â”€â”€ */
    #gallery {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 12px 18px;
    }
    #gallery h3 { font-size: 0.85rem; color: #8b949e; margin-bottom: 10px; }
    #snapshot-list {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .snap-thumb {
      position: relative;
      cursor: pointer;
      border: 1px solid #30363d;
      border-radius: 6px;
      overflow: hidden;
      transition: border-color 0.15s;
    }
    .snap-thumb:hover { border-color: #58a6ff; }
    .snap-thumb img  { display: block; width: 160px; height: 80px; object-fit: cover; }
    .snap-thumb span {
      display: block;
      text-align: center;
      font-size: 0.65rem;
      color: #8b949e;
      padding: 3px 4px;
      background: #0d1117;
    }

    /* â”€â”€ ì „ì²´í™”ë©´ ìŠ¤ëƒ…ìƒ· ë·°ì–´ â”€â”€ */
    #viewer-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    #viewer-overlay.visible { display: flex; }
    #viewer-overlay img {
      max-width: 95vw;
      max-height: 90vh;
      border-radius: 8px;
      box-shadow: 0 0 40px rgba(0,0,0,0.8);
    }
    #viewer-close {
      position: absolute;
      top: 18px; right: 22px;
      color: #fff;
      font-size: 1.6rem;
      cursor: pointer;
      line-height: 1;
    }
  </style>
</head>
<body>

<!-- â‘  í—¤ë” íŒ¨ë„ -->
<div id="header">
  <div>
    <h1>ğŸ¯ BTC/USDT 1ë¶„ë´‰ &nbsp;ì ì¤‘ë¥  ê²€ì¦ ì°¨íŠ¸</h1>
    <div class="meta-row" style="margin-top:6px;">
      <span><strong id="lbl-period">ê³„ì‚° ì¤‘...</strong></span>
      <span>í˜„ì¬: <strong id="lbl-time">--:--</strong></span>
      <span><span id="ws-dot"></span><span id="lbl-ws">ì—°ê²° ì¤‘...</span></span>
    </div>
  </div>
  <div class="btn-group">
    <button id="btn-snapshot">ğŸ“· ìˆ˜ë™ ìŠ¤ëƒ…ìƒ·</button>
    <button id="btn-reset">ğŸ”„ ì°¨íŠ¸ ì´ˆê¸°í™”</button>
  </div>
</div>

<!-- â‘¡ ì°¨íŠ¸ -->
<div id="chart-wrapper">
  <div id="chart-container"></div>
  <div id="chart-overlay">â³ Binance WebSocket ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
</div>

<!-- â‘¢ í†µê³„ ë°” -->
<div id="stats-bar">
  <div class="stat-item">
    <span class="stat-label">í˜„ì¬ê°€</span>
    <span class="stat-value" id="stat-price">--</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">ëˆ„ì  ìº”ë“¤</span>
    <span class="stat-value" id="stat-candles">0</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">ì˜ˆì¸¡ ê¶¤ì </span>
    <span class="stat-value" id="stat-preds">0</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">êµ¬ê°„ ë³€í™”</span>
    <span class="stat-value" id="stat-change">--</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">ë‹¤ìŒ ìŠ¤ëƒ…ìƒ·ê¹Œì§€</span>
    <span class="stat-value" id="stat-countdown">--</span>
  </div>
</div>

<!-- â‘£ ìŠ¤ëƒ…ìƒ· ê°¤ëŸ¬ë¦¬ -->
<div id="gallery">
  <h3>ğŸ“‚ ìŠ¤ëƒ…ìƒ· íˆìŠ¤í† ë¦¬</h3>
  <div id="snapshot-list"><span style="color:#6e7681;font-size:.8rem;">ì €ì¥ëœ ìŠ¤ëƒ…ìƒ·ì´ ì—†ìŠµë‹ˆë‹¤.</span></div>
</div>

<!-- â‘¤ ìŠ¤ëƒ…ìƒ· ë·°ì–´ -->
<div id="viewer-overlay">
  <span id="viewer-close">âœ•</span>
  <img id="viewer-img" src="" alt="snapshot" />
</div>

<script>
// ============================================================
//  ìœ í‹¸ë¦¬í‹°
// ============================================================
const pad  = n => String(n).padStart(2, '0');
const fmt  = n => n.toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

/**
 * Lightweight ChartsëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ UTCë¡œ í•´ì„í•©ë‹ˆë‹¤.
 * ë¡œì»¬ ì‹œê°„ìœ¼ë¡œ í‘œì‹œí•˜ë ¤ë©´ UTC íƒ€ì„ìŠ¤íƒ¬í”„ì— ë¡œì»¬ ì˜¤í”„ì…‹ì„ ë”í•©ë‹ˆë‹¤.
 * ì˜ˆ) KST(+9h): UTCì´ˆ + 32400 â†’ ì°¨íŠ¸ì— ë¡œì»¬ ì‹œê°ìœ¼ë¡œ í‘œì‹œ
 */
const TZ_OFFSET_S = new Date().getTimezoneOffset() * -60;
function toChartTime(ms) {
  return Math.floor(ms / 1000) + TZ_OFFSET_S;
}

// ============================================================
//  ì°¨íŠ¸ ìƒì„±
// ============================================================
const chartContainer = document.getElementById('chart-container');
const chart = LightweightCharts.createChart(chartContainer, {
  layout: {
    background: { type: 'solid', color: '#131722' },
    textColor: '#d1d4dc',
  },
  grid: {
    vertLines: { color: '#1e2130' },
    horzLines: { color: '#1e2130' },
  },
  timeScale: {
    timeVisible: true,
    secondsVisible: false,
    fixLeftEdge: true,
    fixRightEdge: true,
    borderColor: '#2b2b43',
  },
  rightPriceScale: {
    autoScale: true,
    borderColor: '#2b2b43',
  },
  crosshair: {
    mode: LightweightCharts.CrosshairMode.Normal,
  },
  handleScroll: { mouseWheel: false, pressedMouseMove: false, horzTouchDrag: false },
  handleScale:  { mouseWheel: false, pinch: false, axisPressedMouseMove: false },
});

// ì°½ í¬ê¸°ì— ë§ê²Œ ì°¨íŠ¸ ìë™ ì¡°ì ˆ
const resizeObserver = new ResizeObserver(() => {
  chart.applyOptions({
    width:  chartContainer.clientWidth,
    height: chartContainer.clientHeight,
  });
});
resizeObserver.observe(chartContainer);

// ìº”ë“¤ìŠ¤í‹± ì‹œë¦¬ì¦ˆ (ì‹¤ì œ 1ë¶„ë´‰)
const candleSeries = chart.addCandlestickSeries({
  upColor:       '#26a69a',
  downColor:     '#ef5350',
  borderVisible: false,
  wickUpColor:   '#26a69a',
  wickDownColor: '#ef5350',
});

// â”€â”€ Anchor ì‹œë¦¬ì¦ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 30ë¶„ ì°½ ì–‘ëì— íˆ¬ëª… í¬ì¸íŠ¸ë¥¼ ê³ ì •í•´ Xì¶• ë²”ìœ„ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.
// autoscaleInfoProvider: () => null â†’ Yì¶• ìë™ ìŠ¤ì¼€ì¼ì—ì„œ ì™„ì „íˆ ì œì™¸ë©ë‹ˆë‹¤.
const anchorSeries = chart.addLineSeries({
  color:                 'rgba(0,0,0,0)',
  lineWidth:             0,
  crosshairMarkerVisible: false,
  lastValueVisible:      false,
  priceLineVisible:      false,
  autoscaleInfoProvider: () => null,
});

// ============================================================
//  30ë¶„ ê³ ì • íƒ€ì„ë¼ì¸ ê´€ë¦¬
// ============================================================
let periodStart  = null;   // Date
let periodEnd    = null;   // Date
let _rangeFixed  = false;  // setVisibleRangeê°€ ì‹¤ì œë¡œ ì ìš©ëëŠ”ì§€ ì—¬ë¶€

function calcPeriod(now) {
  const m = now.getMinutes();
  const startMin = m < 30 ? 0 : 30;

  const s = new Date(now);
  s.setMinutes(startMin, 0, 0);
  s.setMilliseconds(0);

  const e = new Date(s);
  e.setMinutes(startMin + 30, 0, 0);   // JS Dateê°€ 60ë¶„ ë„˜ìœ¼ë©´ ìë™ìœ¼ë¡œ ì‹œê°„ ì˜¬ë¦¼

  return { start: s, end: e };
}

/**
 * Anchor ì‹œë¦¬ì¦ˆì— í˜„ì¬ ê°€ê²©ìœ¼ë¡œ 30ë¶„ ì°½ ì–‘ë í¬ì¸íŠ¸ë¥¼ ì‹¬ìŠµë‹ˆë‹¤.
 * ì²« í˜¸ì¶œ ì‹œ setVisibleRangeë¥¼ í•œ ë²ˆ í™•ì • ì ìš©í•©ë‹ˆë‹¤.
 */
function refreshAnchor(price) {
  if (!periodStart || !periodEnd || price <= 0) return;
  const fromTs = toChartTime(periodStart.getTime());
  const toTs   = toChartTime(periodEnd.getTime());
  // í˜„ì¬ê°€ì™€ ë™ì¼í•œ ê°’ì´ë¯€ë¡œ Yì¶•ì—ëŠ” ì‹¤ì§ˆì  ì˜í–¥ ì—†ìŒ
  anchorSeries.setData([
    { time: fromTs, value: price },
    { time: toTs,   value: price },
  ]);
  // ì•„ì§ rangeê°€ í™•ì • ì ìš©ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì§€ê¸ˆ ì ìš©
  if (!_rangeFixed) {
    try {
      chart.timeScale().setVisibleRange({ from: fromTs, to: toTs });
      _rangeFixed = true;
    } catch (_) {}
  }
}

function applyFixedTimeline(start, end) {
  const startStr = `${pad(start.getHours())}:${pad(start.getMinutes())}`;
  const endStr   = `${pad(end.getHours())}:${pad(end.getMinutes())}`;
  document.getElementById('lbl-period').textContent =
    `í˜„ì¬ êµ¬ê°„: ${startStr} ~ ${endStr}`;
  // ê°€ê²©ì´ ì´ë¯¸ ìˆìœ¼ë©´ anchor ì¦‰ì‹œ ê°±ì‹ , ì—†ìœ¼ë©´ ì²« ìº”ë“¤ ìˆ˜ì‹  ì‹œ ìë™ ê°±ì‹ 
  if (lastClose) refreshAnchor(lastClose);
}

// ============================================================
//  ì°¨íŠ¸ ìƒíƒœ
// ============================================================
let predictionSeriesList = [];   // ëˆ„ì  ì˜ˆì¸¡ LineSeries ëª©ë¡
let candleCount   = 0;
let lastCandleTs  = 0;           // ë§ˆì§€ë§‰ìœ¼ë¡œ ì¹´ìš´íŠ¸í•œ ìº”ë“¤ì˜ timestamp (ì¤‘ë³µ ë°©ì§€)
let periodOpen    = null;        // êµ¬ê°„ ì²« ë²ˆì§¸ ìº”ë“¤ ì‹œê°€ (ë³€í™”ìœ¨ ê³„ì‚°ìš©)
let lastClose     = null;

function resetChart() {
  // ëª¨ë“  ì˜ˆì¸¡ ì‹œë¦¬ì¦ˆ ì œê±°
  predictionSeriesList.forEach(s => {
    try { chart.removeSeries(s); } catch (_) {}
  });
  predictionSeriesList = [];

  // ìº”ë“¤ & anchor ì´ˆê¸°í™”
  candleSeries.setData([]);
  anchorSeries.setData([]);
  candleCount  = 0;
  lastCandleTs = 0;
  periodOpen   = null;
  _rangeFixed  = false;   // ìƒˆ êµ¬ê°„ì´ë¯€ë¡œ range ì¬í™•ì • í•„ìš”
  document.getElementById('stat-candles').textContent = '0';
  document.getElementById('stat-preds').textContent   = '0';
  document.getElementById('stat-change').textContent  = '--';
  document.getElementById('stat-change').className    = 'stat-value';

  // ìƒˆ êµ¬ê°„ íƒ€ì„ë¼ì¸ ì„¤ì •
  const { start, end } = calcPeriod(new Date());
  periodStart = start;
  periodEnd   = end;
  applyFixedTimeline(start, end);
}

// ì´ˆê¸°í™”
resetChart();

// ============================================================
//  ìŠ¤ëƒ…ìƒ·
// ============================================================
function makePeriodFilename(start, end) {
  const dateStr  = `${start.getFullYear()}-${pad(start.getMonth()+1)}-${pad(start.getDate())}`;
  const startStr = `${pad(start.getHours())}${pad(start.getMinutes())}`;
  const endStr   = `${pad(end.getHours())}${pad(end.getMinutes())}`;
  return `${dateStr}_${startStr}_${endStr}.png`;
}

async function captureAndSend(filename) {
  let dataURL = null;
  try {
    const canvas = chart.takeScreenshot();
    if (canvas && typeof canvas.toDataURL === 'function') {
      dataURL = canvas.toDataURL('image/png');
    }
  } catch (_) {}

  if (!dataURL) {
    // fallback: DOMì—ì„œ ìº”ë²„ìŠ¤ ì§ì ‘ íƒìƒ‰
    const canvas = chartContainer.querySelector('canvas');
    if (canvas) dataURL = canvas.toDataURL('image/png');
  }
  if (!dataURL) { console.warn('ìŠ¤ëƒ…ìƒ· ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

  try {
    const res = await fetch('/save_snapshot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: dataURL, filename }),
    });
    const json = await res.json();
    console.log('ğŸ“¸ ìŠ¤ëƒ…ìƒ· ì €ì¥:', json.filename, `(${(json.size/1024).toFixed(1)} KB)`);
    loadSnapshotGallery();
  } catch (e) {
    console.error('ìŠ¤ëƒ…ìƒ· ì „ì†¡ ì‹¤íŒ¨:', e);
  }
}

async function takeSnapshotAndReset() {
  const filename = makePeriodFilename(periodStart, periodEnd);
  await captureAndSend(filename);
  resetChart();
}

document.getElementById('btn-snapshot').addEventListener('click', takeSnapshotAndReset);
document.getElementById('btn-reset').addEventListener('click', resetChart);

// ============================================================
//  ê°¤ëŸ¬ë¦¬
// ============================================================
async function loadSnapshotGallery() {
  try {
    const res  = await fetch('/snapshots');
    const data = await res.json();
    const list = document.getElementById('snapshot-list');
    if (!data.snapshots || data.snapshots.length === 0) {
      list.innerHTML = '<span style="color:#6e7681;font-size:.8rem;">ì €ì¥ëœ ìŠ¤ëƒ…ìƒ·ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
      return;
    }
    list.innerHTML = '';
    data.snapshots.forEach(name => {
      const thumb = document.createElement('div');
      thumb.className = 'snap-thumb';
      thumb.title = name;
      thumb.innerHTML = `<img src="/snapshots/${name}" alt="${name}" loading="lazy"><span>${name.replace('.png','')}</span>`;
      thumb.addEventListener('click', () => openViewer(`/snapshots/${name}`));
      list.appendChild(thumb);
    });
  } catch (_) {}
}

function openViewer(src) {
  const ov = document.getElementById('viewer-overlay');
  document.getElementById('viewer-img').src = src;
  ov.classList.add('visible');
}
document.getElementById('viewer-close').addEventListener('click', () => {
  document.getElementById('viewer-overlay').classList.remove('visible');
});
document.getElementById('viewer-overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) e.currentTarget.classList.remove('visible');
});

loadSnapshotGallery();

// ============================================================
//  UI íƒ€ì´ë¨¸ (1ì´ˆë§ˆë‹¤ ì‹œê° + ì¹´ìš´íŠ¸ë‹¤ìš´ ê°±ì‹ )
// ============================================================
function updateUI() {
  const now = new Date();
  document.getElementById('lbl-time').textContent =
    `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

  if (periodEnd) {
    const remainMs = periodEnd.getTime() - now.getTime();
    if (remainMs > 0) {
      const mm = Math.floor(remainMs / 60000);
      const ss = Math.floor((remainMs % 60000) / 1000);
      document.getElementById('stat-countdown').textContent = `${pad(mm)}:${pad(ss)}`;
    } else {
      document.getElementById('stat-countdown').textContent = '00:00';
    }
  }
}
setInterval(updateUI, 1000);
updateUI();

// ============================================================
//  WebSocket ì—°ê²° (ìë™ ì¬ì—°ê²° í¬í•¨)
// ============================================================
let ws = null;
let wsRetryDelay = 2000;
let firstCandleReceived = false;

function setWsStatus(status, text) {
  const dot = document.getElementById('ws-dot');
  const lbl = document.getElementById('lbl-ws');
  dot.className = status;
  lbl.textContent = text;
}

function connectWS() {
  setWsStatus('connecting', 'ì—°ê²° ì¤‘...');
  ws = new WebSocket(`ws://${location.host}/ws`);

  ws.onopen = () => {
    setWsStatus('connected', 'ì—°ê²°ë¨ ğŸŸ¢');
    wsRetryDelay = 2000;
    console.log('âœ… WebSocket ì—°ê²°');
  };

  ws.onclose = () => {
    setWsStatus('disconnected', `ì¬ì—°ê²° ì¤‘... (${wsRetryDelay/1000}s)`);
    console.warn(`WebSocket ë‹«í˜, ${wsRetryDelay}ms í›„ ì¬ì—°ê²°`);
    setTimeout(connectWS, wsRetryDelay);
    wsRetryDelay = Math.min(wsRetryDelay * 2, 30000);
  };

  ws.onerror = err => {
    console.error('WebSocket ì˜¤ë¥˜:', err);
  };

  ws.onmessage = (event) => {
    let data;
    try { data = JSON.parse(event.data); }
    catch (_) { return; }

    const now = new Date();

    // ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
    if (!firstCandleReceived) {
      firstCandleReceived = true;
      const ov = document.getElementById('chart-overlay');
      ov.classList.add('hidden');
    }

    // â”€â”€ 30ë¶„ êµ¬ê°„ ê²½ê³„ ì²´í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (periodEnd && now >= periodEnd) {
      console.log('â° 30ë¶„ êµ¬ê°„ ì¢…ë£Œ â†’ ìŠ¤ëƒ…ìƒ· + ì´ˆê¸°í™”');
      takeSnapshotAndReset();
      return;  // resetChart ë‚´ë¶€ì—ì„œ periodEnd ê°±ì‹ ë¨
    }

    // â”€â”€ ì‹¤ì‹œê°„ ìº”ë“¤ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (data.type === 'real_time_candle') {
      const c = data.candle;
      const chartCandle = {
        time:  toChartTime(c.time * 1000),
        open:  c.open,
        high:  c.high,
        low:   c.low,
        close: c.close,
      };

      candleSeries.update(chartCandle);
      lastClose = c.close;

      // êµ¬ê°„ ì²« ìº”ë“¤ì˜ open ì €ì¥
      if (periodOpen === null) periodOpen = c.open;

      // ìƒˆë¡œìš´ íƒ€ì„ìŠ¤íƒ¬í”„(ìƒˆ ìº”ë“¤ ì‹œì‘)ì¼ ë•Œë§Œ ìº”ë“¤ ì¹´ìš´íŠ¸ ì¦ê°€
      if (chartCandle.time !== lastCandleTs) {
        lastCandleTs = chartCandle.time;
        candleCount++;
        document.getElementById('stat-candles').textContent = candleCount;
      }

      // í˜„ì¬ê°€ & êµ¬ê°„ ë³€í™”ìœ¨
      document.getElementById('stat-price').textContent = fmt(c.close);
      const change = periodOpen ? ((c.close - periodOpen) / periodOpen * 100) : 0;
      const el = document.getElementById('stat-change');
      el.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(3)}%`;
      el.className   = `stat-value ${change >= 0 ? 'up' : 'down'}`;

      // Xì¶• 30ë¶„ ê³ ì • ì•µì»¤ ê°±ì‹  (ì•„ì§ ë¯¸ì ìš© ìƒíƒœë¼ë©´ ì´ ì‹œì ì— í™•ì • ì ìš©)
      refreshAnchor(c.close);
    }

    // â”€â”€ ì˜ˆì¸¡ ê¶¤ì  ì˜¤ë²„ë ˆì´ (ì ˆëŒ€ ì‚­ì œí•˜ì§€ ì•ŠìŒ) â”€â”€â”€â”€â”€â”€â”€
    if (data.type === 'prediction' && Array.isArray(data.predictions)) {

      // ìƒ‰ìƒ: ê°™ì€ êµ¬ê°„ ë‚´ì—ì„œ íšŒìƒ‰â†’íŒŒë€ìƒ‰ìœ¼ë¡œ ê·¸ë¼ë°ì´ì…˜ (ìµœëŒ€ 30ê°œ)
      const alpha = 0.25 + Math.min(predictionSeriesList.length / 30, 0.5) * 0.5;
      const hue   = 210 + (predictionSeriesList.length % 30) * 2;

      const predSeries = chart.addLineSeries({
        color:                  `hsla(${hue}, 90%, 65%, ${alpha.toFixed(2)})`,
        lineWidth:              2,
        lineStyle:              LightweightCharts.LineStyle.Dashed,
        crosshairMarkerVisible: false,
        lastValueVisible:       false,
        priceLineVisible:       false,
        autoscaleInfoProvider:  () => null,  // ì˜ˆì¸¡ì„ ì´ Yì¶• ìŠ¤ì¼€ì¼ì— ì˜í–¥ ìµœì†Œí™”
      });

      const points = data.predictions.map(p => ({
        time:  toChartTime(p.time * 1000),
        value: p.value,
      }));

      // ì˜ˆì¸¡ ê¶¤ì ì˜ ì‹œì‘ì ì„ í˜„ì¬ ìº”ë“¤ ì¢…ê°€ì— ì—°ê²°
      if (lastClose !== null && points.length > 0) {
        const originTime = data.origin_time
          ? toChartTime(data.origin_time * 1000)
          : points[0].time - 60;
        predSeries.setData([{ time: originTime, value: lastClose }, ...points]);
      } else {
        predSeries.setData(points);
      }

      predictionSeriesList.push(predSeries);
      document.getElementById('stat-preds').textContent = predictionSeriesList.length;

      // ì˜ˆì¸¡ì„ ì´ 30ë¶„ ì°½ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ range ì¬í™•ì¸
      if (lastClose) refreshAnchor(lastClose);
    }
  };
}

connectWS();
</script>
</body>
</html>
